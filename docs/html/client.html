<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>偶云客-IM客户端</title>
    <!-- cdn引入ElementUI样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">

</head>

<body>
<div id="app">


    <!--登录弹框-->
    <el-dialog :close-on-press-escape="false" :close-on-click-modal="false" :destroy-on-close="true" :show-close="false"
               :fullscreen="true" center :visible.sync="dialogFormLoginVisible">
        <div class="cq1">
            <el-steps :active="activeStep" finish-status="success">
                <el-step @click.native="activeStep !== 0? activeStep = 0: ''" title="设置"
                         icon="el-icon-s-tools"></el-step>
                <el-step
                        @click.native="activeStep === 1? '': settingForm.httpServerAddress && settingForm.wsServerAddress && settingForm.offlinePullWay? activeStep = 1: ''"
                        title="注册/登录" icon="el-icon-position"></el-step>
            </el-steps>
        </div>

        <!--表单内容-->
        <div class="cq2" v-show="activeStep === 1">
            <div class="m5">{{register ? '注册' : '登录'}}</div>

            <el-form v-show="register" :model="registerForm" :rules="registerFormRules" ref="registerForm"
                     label-width="100px" class="demo-ruleForm">
                <el-form-item label="用户名" prop="username">
                    <el-input v-model="registerForm.username"></el-input>
                </el-form-item>
                <el-form-item label="手机号" prop="phoneNum">
                    <el-input v-model="registerForm.phoneNum"></el-input>
                </el-form-item>
                <el-form-item label="密码" prop="password">
                    <el-input v-model="registerForm.password" autocomplete="off"></el-input>
                </el-form-item>
                <el-form-item label="确认密码" prop="confirmPassword">
                    <el-input v-model="registerForm.confirmPassword" autocomplete="off"></el-input>
                </el-form-item>
            </el-form>


            <el-form v-show="!register" :model="loginForm" :rules="loginFormRules" ref="loginForm" label-width="100px"
                     class="demo-ruleForm">
                <el-form-item label="手机号" prop="phoneNum">
                    <el-input v-model="loginForm.phoneNum"></el-input>
                </el-form-item>
                <el-form-item label="密码" prop="password">
                    <el-input v-model="loginForm.password"></el-input>
                </el-form-item>
            </el-form>
            <div class="m1" v-if="register">
                <div class="m2">
                    <span>已有账号?</span>
                    <el-link @click="goLogin" style="font-size: 20px;" type="primary">去登录</el-link>
                </div>
                <el-button style="width:150px" @click="doRegister" type="primary">注册</el-button>
            </div>
            <div class="m1" v-else>
                <div class="m2">
                    <span>没有账号?</span>
                    <el-link @click="goRegister" style="font-size: 20px;" type="primary">去注册</el-link>
                </div>
                <el-button style="width:150px" @click="doLogin" type="primary">登录</el-button>
            </div>
        </div>

        <div class="cq3" v-if="activeStep === 0">
            <el-form label-width="150px" :model="settingForm" :rules="settingFormRules" ref="settingRuleForm"
                     label-width="100px" class="demo-ruleForm">
                <el-form-item label="http后端服务器地址" prop="httpServerAddress">
                    <el-input v-model="settingForm.httpServerAddress"
                              placeholder="http://127.0.0.1:8080/api"></el-input>
                </el-form-item>
                <el-form-item label="IM后端服务器地址" prop="wsServerAddress">
                    <el-input v-model="settingForm.wsServerAddress" placeholder="ws://127.0.0.1:8080"></el-input>
                </el-form-item>
                <el-form-item label="拉取离线消息模式" prop="offlinePullWay">
                    <el-select v-model="settingForm.offlinePullWay" placeholder="请选择拉取方式">
                        <el-option label="按需拉取" value="1"></el-option>
                        <el-option label="全量拉取" value="0"></el-option>
                    </el-select>
                </el-form-item>

            </el-form>
            <el-button type="primary" @click="submitSettingForm">确定</el-button>

        </div>
    </el-dialog>


    <el-drawer :visible.sync="drawer" :with-header="false">
        <div class="notice" v-for="(item, index) in notifyInfoList" :key="index">
            <div>
                <el-avatar :size="35" icon="el-icon-user-solid" :src="item.avatar"></el-avatar>
            </div>
            <div class="c1">
                <div class="c2">
                    <div><span class="c3">{{item.username || item.nickName}}</span></div>
                    <div v-if="item.type == 2"><span class="last-msg">申请加入{{item.groupName}}群</span></div>
                    <div class="c4"><span class="last-msg">{{item.lastMsg}}</span></div>
                </div>
                <div class="c5">
                    <el-button v-if="item.handleNotify && item.handleStatus ==1" type="primary" disabled>已同意</el-button>
                    <el-button v-if="item.handleNotify && item.handleStatus==2" type="primary" disabled>已拒绝</el-button>
                    <el-button v-if="item.handleNotify && item.handleStatus == 3" type="primary" disabled>待验证
                    </el-button>
                    <el-button v-if="item.handleNotify && item.handleStatus == 4" type="primary" disabled>对方拒绝
                    </el-button>
                    <el-button v-if="item.handleNotify && item.handleStatus == 5" type="primary" disabled>对方同意
                    </el-button>


                    <el-button v-if="!item.handleNotify && item.type == 1" type="primary" @click="agreeFriend(item)">同意</el-button>
                    <el-button v-if="!item.handleNotify && item.type == 1" type="danger" @click="refuseFriend(item)">拒绝</el-button>

                    <el-button v-if="!item.handleNotify && item.type == 2" type="primary" @click="agreeGroup(item)">同意</el-button>
                    <el-button v-if="!item.handleNotify && item.type == 2" type="danger" @click="refuseGroup(item)">拒绝</el-button>
                </div>

            </div>

        </div>


    </el-drawer>
    <el-container class="container">
        <el-header class="header-container">
            <div style="display: flex"><i style="font-size: 30px" class="el-icon-setting"></i></div>
            <div><span class="header">偶云客(ouyunc)-IM客户端 v3.0.1</span></div>
            <div class="header-login">
                <el-badge :is-dot="notify" class="item-dot">
                    <div @click="popDraw" style="width:40px;height: 40px"><i style="font-size: 30px" class="el-icon-bell"></i></div>
                </el-badge>
                <el-avatar :size="45" icon="el-icon-user-solid" :src="currentLoginUser.avatar"></el-avatar>
                <span>{{currentLoginUser.username}}</span>
                <i style="font-size: 20px" class="el-icon-caret-bottom"></i>
            </div>
        </el-header>
        <el-container>
            <el-aside width="20vw">
                <el-header class="chat-header" style="justify-content: space-between;">
                    <div></div>
                    <div><span>联系人</span></div>
                    <div>
                        <el-dropdown @command="handleCommand" trigger="click">
                                <span class="el-dropdown-link">
                                    <i style="font-size: 26px" class="el-icon-circle-plus-outline"></i>
                                </span>
                            <el-dropdown-menu slot="dropdown">
                                <el-dropdown-item command="0" icon="el-icon-user-solid">添加好友</el-dropdown-item>
                                <el-dropdown-item command="1" :divided="true" icon="el-icon-s-custom">添加群
                                </el-dropdown-item>
                                <el-dropdown-item command="2" :divided="true" icon="el-icon-paperclip">创建群
                                </el-dropdown-item>
                            </el-dropdown-menu>
                        </el-dropdown>
                    </div>
                </el-header>

                <el-tree  :data="contactList" :props="defaultProps" accordion @node-click="handleNodeClick">
                    <div class="custom-tree-node" slot-scope="{ node, data }">
                        <div>
                            <el-badge :value="data.unreadContent" :max="99" class="item">
                                <el-avatar :size="35" icon="el-icon-user-solid" :src="data.avatar"></el-avatar>
                            </el-badge>
                        </div>
                        <div class="c11">
                            <div class="c12">
                                <div>
                                    <span style="font-size: 16px;color: #303133">{{ data.username }}</span>
                                    <el-tag size="mini" v-if="data.id == currentLoginUser.id">
                                        我
                                    </el-tag>
                                </div>
                                <div style="width:12vw;display: flex;"><span
                                        class="last-msg">{{data.lastMsgContent}}</span></div>
                            </div>
                            <div class="c13">
                                <el-tag size="mini" v-if="data.isLeader">
                                    群主
                                </el-tag>

                                <el-tag size="mini" v-if="data.isManager">
                                    管理员
                                </el-tag>
                                <el-tag v-if="data.type == 1 && data.parentId == 0" :type="data.online == 1 ? 'success':'info'" size="mini">
                                    {{data.online == 1 ? '在线' : '离线'}}
                                </el-tag>
                            </div>
                        </div>

                    </div>
                </el-tree>
            </el-aside>
            <el-container class="main-chat-container">
                <el-header class="chat-header">
                    <span>{{selectedChatUserInfo.type == 1? `正在和`+selectedChatUserInfo.username+`聊天` : selectedChatUserInfo.username}}</span>
                    <el-tag :type="selectedChatUserInfo.online == 1 ? 'success':'info'" v-if="selectedChatUserInfo.type == 1" size="mini">{{selectedChatUserInfo.online == 1? '在线':'离线'}}</el-tag>
                </el-header>

                <!--聊天区-->
                <el-main class="chat-container">
                    <!--其他人-->
                    <template v-for="(item , index) in currentChatMsgList">

                        <div class="others" v-if="item.id !== currentLoginUser.id">
                            <div class="chat-avatar">
                                <el-avatar icon="el-icon-user-solid" fit="fill" :src="item.avatar"></el-avatar>
                            </div>
                            <div class="chat-right" style="align-items: flex-start">
                                <div class="chat-user-msg">
                                    <span style="color: #303133;margin-left: 10px">{{item.username}}</span>
                                    <span style="font-size: 5px;color: #606266;margin-left: 10px">{{item.timestamp |
                                            dateFormat}}</span>
                                </div>
                                <div class="chat-msg">
                                    <span style="margin: 5px">{{item.msgContent}}</span>
                                </div>
                            </div>
                        </div>


                        <!--我的-->
                        <div class="my" v-else>
                            <div class="chat-avatar">
                                <el-avatar icon="el-icon-user-solid" fit="fill" :src="item.avatar"></el-avatar>
                            </div>
                            <div class="chat-right">
                                <div class="chat-user-msg-my">
                                        <span style="font-size: 5px;color: #606266;margin-left: 10px">{{item.timestamp |
                                                dateFormat}}</span>
                                </div>
                                <div class="chat-msg-my">
                                    <span style="margin: 5px">{{item.msgContent}}</span>
                                </div>
                            </div>
                        </div>
                    </template>


                </el-main>


                <el-footer class="footer-container">
                    <el-input placeholder="请输入内容" type="textarea" @keyup.enter.native="doSend()" :autosize="{ minRows: 1, maxRows: 2 }"
                              v-model="chatContent"></el-input>
                    <el-button type="primary" @click="doSend">发送</el-button>
                </el-footer>
            </el-container>
            <el-aside width="30vw">
                <div class="user-detail-container">
                    <div class="user-detail">
                        <div class="left-avatar">
                            <el-avatar :size="60" fit="fill"
                                       :src="currentSelectContactDetailInfo.avatar"></el-avatar>
                        </div>
                        <div class="right-user-info"><span
                                style="font-size: 18px">{{currentSelectContactDetailInfo.username || currentSelectContactDetailInfo.nickName}}</span>
                        </div>
                    </div>
                    <div class="divider"></div>
<!--                    <div class="user-tools">-->
<!--                        <el-button style="width:40%" type="primary">-->
<!--                            {{currentSelectContactDetailInfo.isShield == 0 ? '解除屏蔽' : '屏蔽好友'}}-->
<!--                        </el-button>-->
<!--                        <el-button style="width:40%" type="primary">删除好友</el-button>-->
<!--                    </div>-->
                </div>
            </el-aside>
        </el-container>
    </el-container>


    <el-dialog @closed="searchFriendDialogClose" :close-on-click-modal="false" :destroy-on-close="true" :show-close="true" center
               :visible.sync="addFriendDialogVisible">
        <el-dialog v-if="addFriendInnerVisible"
                   title="请输入想说的话"
                   width="30%"
                   :close-on-click-modal="false"
                   :destroy-on-close="true" :show-close="true" center
                   :visible.sync="addFriendInnerVisible"
                   append-to-body>
            <el-input
                    type="text"
                    placeholder="请输入想说的话"
                    v-model="tempChatContent"
                    maxlength="10"
                    show-word-limit></el-input>

            <el-button style="margin-top: 20px;margin-left: 70%" @click="tempChatClick" type="primary">确定</el-button>
        </el-dialog>
        <div class="add-friend-container">
            <div style="padding: 10px 20px 10px 20px;">
                <el-input placeholder="请输入手机号/用户名" v-model="searchContent" class="input-with-select">
                    <el-button slot="append" @click="searchFriendClick" icon="el-icon-search"></el-button>
                </el-input>
            </div>
            <el-divider>搜索结果</el-divider>
            <div class="search-container">
                <el-empty v-if="searchFriendContent.length == 0" description="暂无数据"></el-empty>
                <div v-else>
                    <div class="notice" v-for="(item, index) in searchFriendContent" :key="index">
                        <div>
                            <el-avatar :size="35" icon="el-icon-user-solid" :src="item.avatar"></el-avatar>
                        </div>
                        <div class="c1">
                            <div class="c2">
                                <span class="c3">{{item.username}}</span>
                            </div>
                            <div class="c5">
                                <el-button size="small" type="primary" @click="addfriendChatClick(item)">添加好友
                                </el-button>
                            </div>
                        </div>

                    </div>

                </div>
            </div>

        </div>
    </el-dialog>
    <el-dialog @closed="searchFriendDialogClose" :close-on-click-modal="false" :destroy-on-close="true" :show-close="true" center
               :visible.sync="addGroupDialogVisible">
        <el-dialog
                title="请输入想说的话"
                width="30%"
                :close-on-click-modal="false"
                :destroy-on-close="true" :show-close="true" center
                :visible.sync="addGroupInnerVisible"
                append-to-body>
            <el-input
                    type="text"
                    placeholder="请输入想说的话"
                    v-model="tempChatContent"
                    maxlength="10"
                    show-word-limit></el-input>

            <el-button style="margin-top: 20px;margin-left: 70%" @click="joinGroup" type="primary">确定</el-button>
        </el-dialog>
        <div class="add-friend-container">
            <div style="padding: 10px 20px 10px 20px;">
                <el-input placeholder="请输入群id/名称" v-model="searchContent" class="input-with-select">
                    <el-button slot="append" @click="searchGroupClick" icon="el-icon-search"></el-button>
                </el-input>
            </div>
            <el-divider>搜索结果</el-divider>
            <div class="search-container">
                <el-empty v-if="searchFriendContent.length == 0" description="暂无数据"></el-empty>
                <div v-else >
                    <el-radio-group v-model="checkedRadioGroupId">

                        <el-radio  v-for="(item, index) in searchFriendContent" :key="index"  :label="item.id" style="margin-right: 5px">
                            <div class="notice" @click="addGroupInnerVisible = true">
                                <div>
                                    <el-avatar :size="35" icon="el-icon-user-solid" :src="item.groupAvatar"></el-avatar>
                                </div>
                                <div class="c1">
                                    <div class="c2">
                                        <span class="c3">{{item.groupName}}</span>
                                    </div>
                                    <div class="c5">
                                        <el-button size="small" type="primary" >加群
                                        </el-button>
                                    </div>
                                </div>
                            </div>
                        </el-radio>

                    </el-radio-group>

                </div>
            </div>

        </div>
    </el-dialog>
    <el-dialog title="请勾选入群的人员" :close-on-click-modal="false" :destroy-on-close="true" :show-close="true" center
               :visible.sync="createGroupDialogVisible">
        <div class="add-friend-container" style="width: 70%;padding: 5px">

            <div style="margin-bottom: 10px">
                <el-form ref="createGroupForm" :model="createGroupForm" :rules="createGroupFormRules" label-width="80px">
                    <el-form-item label="群组名称"  prop="groupName">
                        <el-input v-model="createGroupForm.groupName"></el-input>
                    </el-form-item>
                    <el-form-item label="群组描述">
                        <el-input v-model="createGroupForm.groupDescription"></el-input>
                    </el-form-item>
                </el-form>

            </div>
            <el-checkbox-group v-model="checkedGroupUserIds">

                <el-checkbox  v-for="(item, index) in contactList" :key="index"  v-if="item.type == 1" :label="item.id" style="margin-right: 5px">
                    <div class="notice">
                        <div>
                            <el-avatar :size="35" icon="el-icon-user-solid" :src="item.avatar"></el-avatar>
                        </div>
                        <div class="c1">
                            <div class="c2">
                                <span class="c3">{{item.username}}</span>
                            </div>
                        </div>
                    </div>
                </el-checkbox>



            </el-checkbox-group>

        </div>

        <el-button style=" margin-top: 20px; margin-left: 40%;" type="primary" @click="doCreateGroup">立即创建</el-button>
    </el-dialog>
</div>

<!--cdn引入ElementUI组件必须先引入Vue-->
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<!-- cdn引入ElementUI组件库 -->
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<!--cdn引入axios-->
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<!--引入im web sdk-->
<script src="http://10.30.1.49/im/ouyunc-im-sdk.js"></script>
<script type="text/javascript">
    Vue.filter('dateFormat', function (originVal) {
        const dt = new Date(Number(originVal))
        const y = dt.getFullYear()
        const m = (dt.getMonth() + 1 + '').padStart(2, '0')
        const d = (dt.getDate() + '').padStart(2, '0')
        const hh = (dt.getHours() + '').padStart(2, '0')
        const mm = (dt.getMinutes() + '').padStart(2, '0')
        const ss = (dt.getSeconds() + '').padStart(2, '0')
        return `${y}-${m}-${d} ${hh}:${mm}:${ss}`;
    });
    var validatePass = (rule, value, callback) => {
        if (value === '') {
            callback(new Error('请输入密码'));
        } else {
            if (vm.registerForm.confirmPassword !== '') {
                vm.$refs.registerForm.validateField('confirmPassword');
            }
            callback();
        }
    };
    var validatePass2 = (rule, value, callback) => {
        if (value === '') {
            callback(new Error('请再次输入密码'));
        } else if (value !== vm.registerForm.password) {
            callback(new Error('两次输入密码不一致!'));
        } else {
            callback();
        }
    };

    const BASE_URL = "http://10.30.1.49:80/api";
    const WS_RUL = 'ws://10.30.1.49:8001'
    const vm = new Vue({ // 配置对象 options
        // 配置选项(option)
        el: '#app',  // element: 指定用vue来管理页面中的哪个标签区域
        data: {
            createGroupForm: {
                // 群组名称
                groupName: '',
                // 群组描述
                groupDescription: ''
            },
            // im sdk socket
            socket: null,
            // 搜索出来的好友信息
            addGroupInnerVisible: false,
            tempChatContent: '',
            addFriendInnerVisible: false,
            searchFriendContent: [],
            addFriendDialogVisible: false,
            addGroupDialogVisible: false,
            createGroupDialogVisible: false,
            dialogFormLoginVisible: true,
            // 设置表单
            settingForm: {
                // 离线消息默认拉取
                offlinePullWay: '',
                // http 服务地址
                httpServerAddress: '',
                // ws 服务地址
                wsServerAddress: ''
            },
            // 表单校验
            settingFormRules: {
                httpServerAddress: [
                    {required: true, message: '请输入http服务后端地址', trigger: 'blur'},
                ],
                wsServerAddress: [
                    {required: true, message: '请输入IM服务后端地址', trigger: 'blur'},
                ],
                offlinePullWay: [
                    {required: true, message: '请选择一个拉取模式', trigger: 'change'},
                ],
            },
            // 注册表单
            registerForm: {
                // 用户名
                username: '',
                // 手机号
                phoneNum: '',
                // 密码
                password: '',
                // 确认密码
                confirmPassword: ''
            },
            createGroupFormRules:{
                groupName: [
                    {required: true, message: '群组名称不为空！', trigger: 'blur'},
                ],
            },
            // 表单校验
            registerFormRules: {
                username: [
                    {required: true, message: '用户名不能为空！', trigger: 'blur'},
                ],
                phoneNum: [
                    // 添加正则表达式 pattern: /^1[3|5|7|8|9]\d{9}$/，验证手机号是否正确
                    {required: true, message: '请输入手机号', trigger: 'blur'},
                    {pattern: /^1[3|5|7|8|9]\d{9}$/, message: '请输入正确的号码格式', trigger: 'change'},
                    {pattern: /^1[3|5|7|8|9]\d{9}$/, message: '请输入正确的号码格式', trigger: 'blur'}
                ],
                password: [
                    {required: true, validator: validatePass, trigger: 'blur'}
                ],
                confirmPassword: [
                    {required: true, validator: validatePass2, trigger: 'blur'}
                ],
            },
            // 登录表单
            loginForm: {
                // 手机号
                phoneNum: '',
                // 密码
                password: '',
            },
            // 登录表单验证
            loginFormRules: {
                password: [
                    {required: true, message: '密码不能为空！', trigger: 'blur'},
                ],
                phoneNum: [
                    // 添加正则表达式 pattern: /^1[3|5|7|8|9]\d{9}$/，验证手机号是否正确
                    {required: true, message: '请输入手机号', trigger: 'blur'},
                    {pattern: /^1[3|5|7|8|9]\d{9}$/, message: '请输入正确的号码格式', trigger: 'change'},
                    {pattern: /^1[3|5|7|8|9]\d{9}$/, message: '请输入正确的号码格式', trigger: 'blur'}
                ],
            },
            // 选中的要加入群的id
            checkedRadioGroupId: '',
            // 即将加入群的成员
            checkedGroupUserIds:[],
            // 是否是注册页
            register: false,
            activeStep: 1,
            // 加好友信息抽屉
            drawer: false,
            // 聊天内容
            chatContent: '',
            // 联系人列表
            contactList: [],
            defaultProps: {
                label: 'username',
                children: 'groupUsers'
            },
            // 当前登录人信息
            currentLoginUser: {
                // id: 1,
                // username: '偶云客',
                // avatar: 'http://localhost:8080/xxxx',
            },
            // 当前聊天消息列表
            //currentChatMsgList:[],
            // 聊天的历史消息列表
            msgRecordList: [
                //     {
                //     // 会话id，指的是群id或from和to的顺序组合唯一值
                //     sessionId: '',
                //     // 聊天内容列表
                //     chatMsgList: [
                //         // {
                //         //     id: 1,
                //         //     username: '张三',
                //         //     avatar: 'https://fuss10.elemecdn.com/e/5d/4a731a90594a4af544c0c25941171jpeg.jpeg',
                //         //     msgType: 1,
                //         //     msgContent: '你好',
                //         //     timestamp: '1678090456592',
                //         // },
                //         // {
                //         //     id: 2,
                //         //     username: '李四',
                //         //     avatar: 'https://fuss10.elemecdn.com/e/5d/4a731a90594a4af544c0c25941171jpeg.jpeg',
                //         //     msgType: 1,
                //         //     msgContent: '你也好',
                //         //     timestamp: '1678090456591',
                //         // }
                //     ],
                // }
            ],
            // 已经选中的聊天联系人
            selectedChatUserInfo: {},
            // 当前选中的联系人详情信息
            currentSelectContactDetailInfo: {},
            // 是否有新通知
            notify: false,
            // 通知信息列表
            notifyInfoList: [],
            // 搜索内容
            searchContent: '',
            // 选中临时聊天的用户信息
            selectedTempChatUserInfo: null,

        },
        computed: {
            // 一个计算属性的 getter
            currentChatMsgList() {
                let sessionId;
                if (this.selectedChatUserInfo.type == 1) {
                    // 将消息追加到会话历史列表中，并更新当前聊天列表内容
                    sessionId = this.selectedChatUserInfo.id > this.currentLoginUser.id ? this.selectedChatUserInfo.id + "_" + this.currentLoginUser.id : this.currentLoginUser.id + "_" + this.selectedChatUserInfo.id;
                }
                if (this.selectedChatUserInfo.type == 2) {
                    sessionId = this.selectedChatUserInfo.id;
                }
                let result = [];
                this.msgRecordList.forEach(item => {
                    // 生成组合唯一标识
                    if (sessionId == item.sessionId) {
                        result = item.chatMsgList;
                    }
                });
                return result;
            }
        },
        methods: {
            // ============================im socket 业务处理===============
            // 定义socket几个回调方法
            onopen(e) {
                // 这里登录
                console.log('连接打开了' + e)
                // 登录
                this.socket.send({
                    // 登录消息类型，
                    messageType: 2,
                    // 消息
                    message: {
                        // 消息发送方唯一标识，建议使用用户id
                        from: this.currentLoginUser.id,
                        // 消息接收方唯一标识，这里是登录，接受者是服务器，值可以为空串
                        to: '',
                        // 消息内容类型
                        contentType: 5,
                        // 消息内容content 是string 类型
                        content: JSON.stringify({
                            identity: this.currentLoginUser.id,
                            appKey: 'appkey',
                            signatureAlgorithm: 1,//md5
                            signature: 'signature',
                            createTime: new Date().getTime()
                        })
                    },
                    // 消息发送方ip(也就是客户端ip)
                    ip: '10.30.1.49',
                    // 消息发送方设备类型
                    deviceType: 13,
                    // 网络类型
                    networkType: 0,
                    // 消息加密算法类型
                    encryptType: 0,
                    // 序列化算法类型
                    serializeAlgorithm: 6
                });
            },
            onmessage(e) {
                let that = this;
                if (e.messageType !== 1) {
                    console.log('接收到消息了')
                    console.log(e)
                    // 收到添加好友类型消息
                    if (e.messageType == 8 && e.message.contentType == 21) {
                        // 添加好友请求的消息
                        this.notify = true;
                        // 追加信息到通知列表中并放到第一位
                        let flag = false;
                        that.notifyInfoList.forEach(item => {
                            if (item.id == e.message.from && item.type == 1) {
                                item.lastMsg = e.message.content
                                flag = true;
                            }
                        });
                        if (!flag) {
                            // 根据发送方查询 发送方的信息
                            axios.get(BASE_URL + `/im-user/` + e.message.from)
                                .then(function (response) {
                                    if (response.data.code == 200) {
                                        that.notifyInfoList = [{
                                            id: e.message.from,
                                            username: response.data.data.username,
                                            nickName: response.data.data.nickName,
                                            avatar: response.data.data.avatar,
                                            type: 1,
                                            // 是否处理通知
                                            handleNotify: false,
                                            // 处理后的结果， false-拒绝， true-同意
                                            handleStatus: false,
                                            lastMsg: e.message.content
                                        }, ...that.notifyInfoList]
                                    } else {
                                        that.$message.error(response.data.message);
                                    }
                                })
                                .catch(function (error) {
                                    that.$message.error('获取好友列表失败！');
                                });
                        }


                    }

                    // 收到对方拒绝添加好友的消息
                    if (e.messageType == 8 && e.message.contentType == 22) {
                        // 更新通知列表，将状态改为对方已拒绝
                        that.notifyInfoList.forEach(item => {
                            if (item.id == e.message.from && item.type == 1) {
                                item.handleNotify = true;
                                item.handleStatus = 4
                            }
                        });
                        console.log('对方拒绝了')
                    }

                    // 收到对方同意添加好友的消息
                    if (e.messageType == 8 && e.message.contentType == 23) {
                        console.log('对方同意了')
                        // 更新通知列表，然后更新或追加好友列表
                        that.notifyInfoList.forEach(item => {
                            if (item.id == e.message.from && item.type ==1) {
                                item.handleNotify = true;
                                item.handleStatus = 5
                            }
                        });
                        that.getContactList();
                    }

                    // 收到私聊消息
                    if (e.messageType == 5 && e.message.contentType == 51) {
                        // 收到私聊消息，，1，存到历史记录中，2，判断是否在与他的聊天页面，若果是则不处理，若果不是则在联系人列表提示未读信息
                        this.contactList.forEach(item => {
                            if (e.message.from == item.id) {
                                item.lastMsgContent = e.message.content;
                                item.unreadContent = Number(item.unreadContent) + 1;
                            }
                        });
                        let sessionId = e.message.from > this.currentLoginUser.id ? e.message.from + "_" + this.currentLoginUser.id : this.currentLoginUser.id + "_" + e.message.from;
                        axios.get(BASE_URL + `/im-user/` + e.message.from)
                            .then(function (response) {
                                if (response.data.code == 200) {
                                    let flag = false;
                                    that.msgRecordList.forEach(item => {
                                        // 生成组合唯一标识
                                        if (sessionId == item.sessionId) {
                                            item.chatMsgList.push({
                                                id: e.message.from,
                                                username: response.data.data.username,
                                                avatar: response.data.data.avatar,
                                                msgType: 1,
                                                msgContent: e.message.content,
                                                timestamp: e.message.createTime
                                            });
                                            flag = true;
                                            //this.currentChatMsgList = item.chatMsgList;
                                        }
                                    });
                                    if (!flag) {
                                        that.msgRecordList.push({
                                            sessionId: sessionId,
                                            chatMsgList: [
                                                {
                                                    id: e.message.from,
                                                    username: response.data.data.username,
                                                    avatar: response.data.data.avatar,
                                                    msgType: 1,
                                                    msgContent: e.message.content,
                                                    timestamp: e.message.createTime
                                                }
                                            ],
                                        });
                                    }
                                } else {
                                    that.$message.error(response.data.message);
                                }
                            })
                            .catch(function (error) {
                                that.$message.error('获取好友列表失败！');
                            });
                    }
                    // 收到加群的消息通知
                    if (e.messageType == 9 && e.message.contentType == 31) {
                        // 显示通知
                        this.notify = true;
                        let flag = false;
                        that.notifyInfoList.forEach(item => {
                            if (item.id == e.message.from && item.type == 2) {
                                item.lastMsg = JSON.parse(e.message.content).data
                                flag = true;
                            }
                        });
                        if (!flag) {
                            // 根据发送方查询 发送方的信息
                            axios.get(BASE_URL + `/im-user/` + e.message.from)
                                .then(function (response) {
                                    if (response.data.code == 200) {
                                        // 获取群信息
                                        axios.get(BASE_URL + `/im-group/search-group?condition=` + e.message.to)
                                            .then(function (res) {
                                                if (res.data.code == 200) {
                                                    let group = res.data.data;
                                                    that.notifyInfoList = [{
                                                        id: e.message.from,
                                                        username: response.data.data.username,
                                                        nickName: response.data.data.nickName,
                                                        avatar: response.data.data.avatar,
                                                        // type = 1 个人， typ-2 群
                                                        type: 2,
                                                        groupName: group[0].groupName,
                                                        // 聊天内容数据
                                                        chatContent: e.message.content,
                                                        // 是否处理通知
                                                        handleNotify: false,
                                                        // 处理后的结果， false-拒绝， true-同意
                                                        handleStatus: false,
                                                        lastMsg: JSON.parse(e.message.content).data
                                                    }, ...that.notifyInfoList]
                                                } else {
                                                    that.$message.error(res.data.message);
                                                }
                                            })
                                            .catch(function (error) {
                                                that.$message.error('获取群列表失败！');

                                            });



                                    } else {
                                        that.$message.error(response.data.message);
                                    }
                                })
                                .catch(function (error) {
                                    that.$message.error('获取好友信息失败！');
                                });
                        }
                    }
                    // 收到加群被拒绝的消息通知
                    if (e.messageType == 9 && e.message.contentType == 32) {
                        console.log('加群被拒绝了')
                    }
                    // 收到加群被同意的消息通知
                    if (e.messageType == 9 && e.message.contentType == 33) {
                        console.log('加群被同意了')
                        // 更新联系人列表
                        axios.get(BASE_URL + `/im-user/${this.currentLoginUser.id}/contact`)
                            .then(function (response) {
                                if (response.data.code == 200) {
                                    that.contactList = response.data.data;
                                } else {
                                    that.$message.error(response.data.message);
                                }
                            })
                            .catch(function (error) {
                                that.$message.error('获取好友列表失败！');
                            });
                    }
                    // 收到群聊消息
                    if (e.messageType == 6 && e.message.contentType == 51) {
                        // 更新联系人列表，如果不存在，这里直接调用接口更新，只是为了简单实现功能，后面根据自己业务开发优化
                        // 将内容显示到联系人上
                        let flag1 = false;
                        that.contactList.forEach(item => {
                            if (e.message.to == item.id) {
                                item.lastMsgContent = e.message.content;
                                item.unreadContent = Number(item.unreadContent) + 1;
                                flag1 = true;
                            }
                        });
                        if (!flag1) {
                            that.getContactList();
                            //that.scheduleUpdateOnlineStatus();
                            that.contactList.forEach(item => {
                                if (e.message.to == item.id) {
                                    item.lastMsgContent = e.message.content;
                                    item.unreadContent = Number(item.unreadContent) + 1;
                                }
                            });
                        }
                        // 将群组id设置为sessionId
                        let sessionId = e.message.to;
                        axios.get(BASE_URL + `/im-user/` + e.message.from)
                            .then(function (response) {
                                if (response.data.code == 200) {
                                    let flag = false;
                                    that.msgRecordList.forEach(item => {
                                        // 生成组合唯一标识
                                        if (sessionId == item.sessionId) {
                                            item.chatMsgList.push({
                                                id: e.message.from,
                                                username: response.data.data.username,
                                                avatar: response.data.data.avatar,
                                                msgType: 1,
                                                msgContent: e.message.content,
                                                timestamp: e.message.createTime
                                            });
                                            flag = true;
                                            //this.currentChatMsgList = item.chatMsgList;
                                        }
                                    });
                                    if (!flag) {
                                        that.msgRecordList.push({
                                            sessionId: sessionId,
                                            chatMsgList: [
                                                {
                                                    id: e.message.from,
                                                    username: response.data.data.username,
                                                    avatar: response.data.data.avatar,
                                                    msgType: 1,
                                                    msgContent: e.message.content,
                                                    timestamp: e.message.createTime
                                                }
                                            ],
                                        });
                                    }
                                } else {
                                    that.$message.error(response.data.message);
                                }
                            })
                            .catch(function (error) {
                                that.$message.error('获取好友列表失败！');
                            });
                    }
                }
            },
            onerror(e) {
                console.log('发生错误了' + e)
            },
            onclose(e) {
                console.log('连接关闭了' + e)
            },


            //========================im 业务逻辑处理=========================
            agreeGroup(item){
                console.log(item)
                let that = this;
                this.socket.send({
                    // 加入群组请求
                    messageType: 9,
                    // 消息
                    message: {
                        // 消息发送方唯一标识，建议使用用户id
                        from: that.currentLoginUser.id,
                        // 消息接收方唯一标识，这里是登录，接受者是服务器，值可以为空串
                        to: item.id,
                        // 消息内容类型,
                        contentType: 33,
                        // 消息内容content 是string 类型
                        content: item.chatContent
                    },
                    // 消息发送方ip(也就是客户端ip)
                    ip: '10.30.1.49',
                    // 消息发送方设备类型
                    deviceType: 13,
                    // 网络类型
                    networkType: 0,
                    // 消息加密算法类型
                    encryptType: 0,
                    // 序列化算法类型
                    serializeAlgorithm: 6
                }, function (packet) {
                    // 追加用户到列表中
                    // 1，修改通知状态
                    item.handleNotify = true;
                    item.handleStatus = 1;
                    let groupId = JSON.parse(item.chatContent).groupId;
                    that.contactList.forEach(contact =>{
                        if (contact.id == groupId) {
                            contact.groupUsers.push({
                                id: item.id,
                                username: item.username,
                                avatar: item.avatar,
                                lastMsgContent: '',
                                parentId: groupId,
                                online: 1,
                                isLeader: 0,
                                isManager: 0,
                                // 1-个人，2-群组
                                type: 1,
                                unreadContent: '',
                                groupUsers: []
                            });
                        }
                    })


                    // 已经发送的消息packet
                    console.log(packet)
                });
            },
            // 拒绝加入群
            refuseGroup(item){
                console.log(item)
                let that = this;
                this.socket.send({
                    // 加入群组请求
                    messageType: 9,
                    // 消息
                    message: {
                        // 消息发送方唯一标识，建议使用用户id
                        from: that.currentLoginUser.id,
                        // 消息接收方唯一标识，这里是登录，接受者是服务器，值可以为空串
                        to: item.id,
                        // 消息内容类型,
                        contentType: 32,
                        // 消息内容content 是string 类型
                        content: item.chatContent
                    },
                    // 消息发送方ip(也就是客户端ip)
                    ip: '10.30.1.49',
                    // 消息发送方设备类型
                    deviceType: 13,
                    // 网络类型
                    networkType: 0,
                    // 消息加密算法类型
                    encryptType: 0,
                    // 序列化算法类型
                    serializeAlgorithm: 6
                }, function (packet) {

                    // 已经发送的消息packet
                    console.log(packet)
                });
            },
            // 加入群组
            joinGroup(){
                let that = this;
                this.socket.send({
                    // 加入群组请求
                    messageType: 9,
                    // 消息
                    message: {
                        // 消息发送方唯一标识，建议使用用户id
                        from: that.currentLoginUser.id,
                        // 消息接收方唯一标识，这里是登录，接受者是服务器，值可以为空串
                        to: that.checkedRadioGroupId,
                        // 消息内容类型,
                        contentType: 31,
                        // 消息内容content 是string 类型
                        content: JSON.stringify({
                            // 群id
                            groupId: that.checkedRadioGroupId,
                            // 申请人唯一标识
                            identity: that.currentLoginUser.id,
                            // 聊天数据
                            data: that.tempChatContent
                        })
                    },
                    // 消息发送方ip(也就是客户端ip)
                    ip: '10.30.1.49',
                    // 消息发送方设备类型
                    deviceType: 13,
                    // 网络类型
                    networkType: 0,
                    // 消息加密算法类型
                    encryptType: 0,
                    // 序列化算法类型
                    serializeAlgorithm: 6
                }, function (packet) {

                    // 已经发送的消息packet
                    console.log(packet)
                });
            },
            // 定时更新好友状态
            // scheduleUpdateOnlineStatus() {
            //     let that = this;
            //     // 获取好友在线状态，之后每个5秒钟获取一次，目前采用拉的方式获取在线状态
            //     axios.get(BASE_URL + `/im-user/${that.currentLoginUser.id}/all-online-status`)
            //         .then(function (response) {
            //             if (response.data.code == 200) {
            //                 // 遍历当前联系人列表，更新状态
            //                 that.contactList.forEach(item =>{
            //                     response.data.data.forEach(item1 =>{
            //                         if (item.id == item1.id) {
            //                             item.online = item1.online;
            //                         }
            //                     });
            //                 });
            //             } else {
            //                 that.$message.error(response.data.message);
            //             }
            //         })
            //         .catch(function (error) {
            //             that.$message.error('获取好友列表失败！');
            //         });
            // },
            // 创建群
            doCreateGroup() {
                let that = this;
                this.$refs.createGroupForm.validate((valid) => {
                    if (valid) {
                        let params = {
                            createUserId: that.currentLoginUser.id,
                            groupAvatar: "",
                            groupDescription: that.createGroupForm.groupDescription,
                            groupName: that.createGroupForm.groupName,
                            groupUserIds: that.checkedGroupUserIds
                        }
                        axios.post(BASE_URL + '/im-group/create-group', params)
                            .then(function (response) {
                                if (response.data.code == 200) {
                                    // 关闭弹框
                                    that.createGroupDialogVisible = false;
                                    that.createGroupForm.groupName = '';
                                    that.createGroupForm.groupDescription = '';
                                    that.checkedGroupUserIds = []
                                    // 拉取联系人
                                    that.getContactList();
                                    // 通知 新加入的人更新联系人列表
                                    that.socket.send({
                                        // 群消息，提示群创建成功
                                        messageType: 6,
                                        // 消息
                                        message: {
                                            // 消息发送方唯一标识，建议使用用户id
                                            from: that.currentLoginUser.id,
                                            // 消息接收方唯一标识，这里是登录，接受者是服务器，值可以为空串
                                            to: response.data.data.id,
                                            // 消息内容类型,
                                            contentType: 51,
                                            // 消息内容content 是string 类型
                                            content: '大家好，我是群主'
                                        },
                                        // 消息发送方ip(也就是客户端ip)
                                        ip: '10.30.1.49',
                                        // 消息发送方设备类型
                                        deviceType: 13,
                                        // 网络类型
                                        networkType: 0,
                                        // 消息加密算法类型
                                        encryptType: 0,
                                        // 序列化算法类型
                                        serializeAlgorithm: 6
                                    }, function (packet) {

                                        // 已经发送的消息packet
                                        console.log(packet)
                                    });
                                } else {
                                    that.$message.error(response.data.message);
                                }
                            })
                            .catch(function (error) {
                                that.$message.error("失败！");
                            });
                    }else {
                        that.$message.error('表单校验失败！');
                        return false;
                    }
                })

            },
            // 同意好友
            agreeFriend(item) {
                let that = this;
                this.socket.send({
                    // 好友请求消息，
                    messageType: 8,
                    // 消息
                    message: {
                        // 消息发送方唯一标识，建议使用用户id
                        from: this.currentLoginUser.id,
                        // 消息接收方唯一标识，这里是登录，接受者是服务器，值可以为空串
                        to: item.id,
                        // 消息内容类型,添加好友的请求内容
                        contentType: 23,
                        // 消息内容content 是string 类型
                        content: ''
                    },
                    // 消息发送方ip(也就是客户端ip)
                    ip: '10.30.1.49',
                    // 消息发送方设备类型
                    deviceType: 13,
                    // 网络类型
                    networkType: 0,
                    // 消息加密算法类型
                    encryptType: 0,
                    // 序列化算法类型
                    serializeAlgorithm: 6
                }, function (packet) {
                    item.handleNotify = true;
                    item.handleStatus = 1;
                    // 将该用户追加到联系人列表中/重新拉取联系人
                    that.contactList = [{
                        id: item.id,
                        username: item.username,
                        avatar: item.avatar,
                        lastMsgContent: '',
                        parentId: '0',
                        online: 1,
                        isLeader: 0,
                        isManager: 0,
                        // 1-个人，2-群组
                        type: 1,
                        unreadContent: '',
                        groupUsers: []
                    }, ...that.contactList];
                    //that.getContactList();
                    // 已经发送的消息packet
                    console.log(packet)
                });
            },
            // 拒绝好友
            refuseFriend(item) {
                this.socket.send({
                    // 好友请求消息，
                    messageType: 8,
                    // 消息
                    message: {
                        // 消息发送方唯一标识，建议使用用户id
                        from: this.currentLoginUser.id,
                        // 消息接收方唯一标识，这里是登录，接受者是服务器，值可以为空串
                        to: item.id,
                        // 消息内容类型,添加好友的请求内容
                        contentType: 22,
                        // 消息内容content 是string 类型
                        content: ''
                    },
                    // 消息发送方ip(也就是客户端ip)
                    ip: '10.30.1.49',
                    // 消息发送方设备类型
                    deviceType: 13,
                    // 网络类型
                    networkType: 0,
                    // 消息加密算法类型
                    encryptType: 0,
                    // 序列化算法类型
                    serializeAlgorithm: 6
                }, function (packet) {
                    item.handleNotify = true;
                    item.handleStatus = 2;
                    // 已经发送的消息packet
                    console.log(packet)
                });
            },
            // 打开新通知的抽屉
            popDraw() {
                this.drawer = true;
                this.notify = false;
            },
            addfriendChatClick(data) {
                this.selectedTempChatUserInfo = data;
                this.addFriendInnerVisible = true;
            },
            // 临时聊天的点击
            tempChatClick() {
                let that = this;
                this.socket.send({
                    // 好友请求消息，
                    messageType: 8,
                    // 消息
                    message: {
                        // 消息发送方唯一标识，建议使用用户id
                        from: this.currentLoginUser.id,
                        // 消息接收方唯一标识，这里是登录，接受者是服务器，值可以为空串
                        to: this.selectedTempChatUserInfo.id,
                        // 消息内容类型,添加好友的请求内容
                        contentType: 21,
                        // 消息内容content 是string 类型
                        content: this.tempChatContent
                    },
                    // 消息发送方ip(也就是客户端ip)
                    ip: '10.30.1.49',
                    // 消息发送方设备类型
                    deviceType: 13,
                    // 网络类型
                    networkType: 0,
                    // 消息加密算法类型
                    encryptType: 0,
                    // 序列化算法类型
                    serializeAlgorithm: 6
                }, function (packet) {
                    // 已经发送的消息packet

                    // 向通知列表追加一条数据，待验证
                    let flag = false;
                    that.notifyInfoList.forEach(item => {
                        if (item.id == that.selectedTempChatUserInfo.id) {
                            flag = true;
                        }
                    });
                    // 如果没有这个人则进行新增一条待验证的数据
                    if (!flag) {
                        // 根据发送方查询 发送方的信息


                        that.notifyInfoList = [{
                            id: that.selectedTempChatUserInfo.id,
                            username: that.selectedTempChatUserInfo.username,
                            nickName: that.selectedTempChatUserInfo.nickName,
                            avatar: that.selectedTempChatUserInfo.avatar,
                            type: 1,
                            // 是否处理通知
                            handleNotify: true,
                            // 处理后的结果， false-拒绝， true-同意
                            handleStatus: 3,
                            lastMsg: that.tempChatContent
                        }, ...that.notifyInfoList]

                    }

                    console.log(packet)
                });
            },
            // 搜索好友弹框关闭时的回调
            searchFriendDialogClose(){
                this.searchContent = '';
                this.searchFriendContent = [];
                this.tempChatContent = '';
                this.checkedGroupUserIds = [];
                this.checkedRadioGroupId = '';
            },
            // 搜索群列表
            searchGroupClick() {
                let that = this;
                axios.get(BASE_URL + `/im-group/search-group?condition=` + this.searchContent)
                    .then(function (response) {
                        if (response.data.code == 200) {
                            that.searchFriendContent = response.data.data;
                        } else {
                            that.$message.error(response.data.message);
                        }
                    })
                    .catch(function (error) {
                        that.$message.error('获取群列表失败！');

                    });
            },
            // 搜索好友列表
            searchFriendClick() {
                let that = this;
                if (this.currentLoginUser.phoneNum == this.searchContent) {
                    that.$message.warning('不要搜索自己！');
                    return
                }
                axios.get(BASE_URL + `/im-user/search-friend?condition=` + this.searchContent)
                    .then(function (response) {
                        if (response.data.code == 200) {
                            that.searchFriendContent = response.data.data;
                        } else {
                            that.$message.error(response.data.message);
                        }
                    })
                    .catch(function (error) {
                        that.$message.error('获取好友列表失败！');

                    });
            },
            // 获取在线好友列表
            getContactList() {
                let that = this;
                axios.get(BASE_URL + `/im-user/${this.currentLoginUser.id}/contact`)
                    .then(function (response) {
                        if (response.data.code == 200) {

                            let arr1 = that.contactList;
                            let arr2 = response.data.data;
                            const diff = arr1.filter(item1 => !arr2.some(item2 => item1.id === item2.id));
                            const add = arr2.filter(item1 => !arr1.some(item2 => item1.id === item2.id));
                            const common = arr1.filter(item1 => arr2.some(item2 => {
                                if (item1.id === item2.id) {
                                    item1.online = item2.online;
                                    item1.groupUsers = item2.groupUsers;
                                }
                                return item1.id === item2.id;
                            }));
                            // 将值从列表总删除
                            diff.forEach(e=>{
                                // 找到对应的索引值
                                that.contactList.splice(that.contactList.findIndex(item=>item.id == e.id),1);
                            })
                            // 循环公共数据，更新群组联系人
                            common.forEach(e=>{

                                let index = that.contactList.findIndex(item=> item.type == 2 && item.id == e.id);
                                if (index > -1) {
                                    // 获取原来群组成员
                                    let groupUsers = that.contactList[index].groupUsers;
                                    // 获取现在群成员
                                    let nowGroupUsers = e.groupUsers;
                                    // 对比这两个进行增减
                                    let diff1 = groupUsers.filter(item1 => !nowGroupUsers.some(item2 => item1.id === item2.id));
                                    let add1 = nowGroupUsers.filter(item1 => !groupUsers.some(item2 => item1.id === item2.id));
                                    diff1.forEach(e=>{
                                        // 找到对应的索引值
                                        that.contactList[index].groupUsers.splice(that.contactList[index].groupUsers.findIndex(item=>item.id == e.id),1);
                                    })
                                    that.contactList[index].groupUsers.push(...add1)
                                }

                            })
                            // push 新的数据
                            that.contactList.push(...add)

                        } else {
                            that.$message.error(response.data.message);
                        }
                    })
                    .catch(function (error) {
                        that.$message.error('获取好友列表失败！');
                    });
            },


            // 登录
            doLogin() {
                this.$refs.loginForm.validate((valid) => {
                    var that = this;
                    if (valid) {
                        axios.post(BASE_URL + '/im/login', this.loginForm)
                            .then(function (response) {
                                if (response.data.code == 200) {
                                    that.currentLoginUser = response.data.data

                                    let defaultConfig = {
                                        // 设备类型: pc_window
                                        deviceType: 13,
                                        // 是否开启心跳，默认true，开启心跳
                                        heartbeatEnable: true,
                                        // 心跳最大等待次数（等待3个心跳时间，如果没有收到消息，则关闭客户端）
                                        heartbeartMaxWait: 3,
                                        // 心跳间隔时间10秒（并不一定10秒内会发一个心跳，如果10秒内都消息接收过来，则不会进行发送）
                                        heartbeartIntervalTime: 10000,
                                        // 心跳读超时时间（客户端发送心跳后，最大等待服务器回复是5秒，超过5秒则进行计数）
                                        heartbeartReadIdleTimeout: 5000,
                                        // 是否开启重连，默认true，开启重连
                                        reconnectEnable: true,
                                        // 如果开启重连，重连的次数，默认-1，一直重连，请设置大于0的整数
                                        reconnectTimes: -1,
                                        // 重连延迟时间，默认 2s
                                        reconnectDelayTime: 2000
                                    };
                                    // 连接websocket
                                    that.socket = new Socket(WS_RUL, defaultConfig);
                                    if (!that.socket) {
                                        that.$message.error('ws 连接失败！');
                                        return;
                                    }
                                    // 回调方法赋值
                                    that.socket.onopen = that.onopen;
                                    that.socket.onmessage = that.onmessage;
                                    that.socket.onerror = that.onerror;
                                    that.socket.onclose = that.onclose;


                                    // 拉取 在线好友列表
                                    that.getContactList();
                                    var timer = setInterval(function() {
                                        that.getContactList();
                                    }, 3000);
                                    that.dialogFormLoginVisible = false;
                                } else {
                                    that.$message.error(response.data.message);
                                }
                            })
                            .catch(function (error) {
                                that.$message.error("登录失败！");
                            });
                    } else {
                        that.$message.error('表单校验失败！');
                        return false;
                    }
                });

            },
            // 注册用户
            doRegister() {
                this.$refs.registerForm.validate((valid) => {
                    var that = this;
                    if (valid) {
                        axios.post(BASE_URL + '/im/register', this.registerForm)
                            .then(function (response) {
                                if (response.data.code == 200) {
                                    that.register = false;
                                } else {
                                    that.$message.error(response.data.message);
                                }
                            })
                            .catch(function (error) {
                                that.$message.error(error.response.data.message);
                            });
                    } else {
                        that.$message.error('表单校验失败！');
                        return false;
                    }
                });
            },
            // 点击添加+号按钮触发的事件
            handleCommand(command) {
                console.log(command);
                // 添加好友
                if (command == 0) {
                    this.addFriendDialogVisible = true;
                    return;
                }
                // 添加群
                if (command == 1) {
                    this.addGroupDialogVisible = true;
                    return;
                }
                // 创建群
                if (command == 2) {
                    this.createGroupDialogVisible = true;
                    return;
                }
            },
            // 点击联系人的回调
            handleNodeClick(data) {
                // 聊天信息重置为空
                //this.currentChatMsgList = [];
                // 将未读消息置为空
                this.contactList.forEach(item => {
                    if (data.id == item.id) {
                        item.unreadContent = '';
                    }
                });
                // 判断点击的是群组还是个人
                // 个人
                this.currentSelectContactDetailInfo = data
                if (data.type == 1) {
                    if (data.parentId == 0) {
                        this.selectedChatUserInfo = data;
                    }else {
                        // 获取群组信息进行处理
                        this.contactList.forEach(item =>{
                            if (item.id == data.parentId) {
                                this.selectedChatUserInfo = item;
                            }
                        });

                    }
                    return
                }
                // 群组
                if (data.type == 2) {
                    this.selectedChatUserInfo = data;
                    return
                }
            },
            // 去注册页面
            goRegister() {
                this.register = true;
            },
            goLogin() {
                this.register = false;
            },
            // 发送信息
            doSend() {
                let that = this;
                if (!this.selectedChatUserInfo) {
                    return
                }
                let messageType;
                let sessionId;
                if (this.selectedChatUserInfo.type == 1) {
                    messageType = 5;
                    // 将消息追加到会话历史列表中，并更新当前聊天列表内容
                    sessionId = that.selectedChatUserInfo.id > that.currentLoginUser.id ? that.selectedChatUserInfo.id + "_" + that.currentLoginUser.id : that.currentLoginUser.id + "_" + that.selectedChatUserInfo.id;

                }
                if (this.selectedChatUserInfo.type == 2) {
                    messageType = 6;
                    sessionId = that.selectedChatUserInfo.id;
                }
                this.socket.send({
                    // 好友请求消息，
                    messageType: messageType,
                    // 消息
                    message: {
                        // 消息发送方唯一标识，建议使用用户id
                        from: that.currentLoginUser.id,
                        // 消息接收方唯一标识，这里是登录，接受者是服务器，值可以为空串
                        to: that.selectedChatUserInfo.id,
                        // 消息内容类型,添加好友的请求内容
                        contentType: 51,
                        // 消息内容content 是string 类型
                        content: that.chatContent
                    },
                    // 消息发送方ip(也就是客户端ip)
                    ip: '10.30.1.49',
                    // 消息发送方设备类型
                    deviceType: 13,
                    // 网络类型
                    networkType: 0,
                    // 消息加密算法类型
                    encryptType: 0,
                    // 序列化算法类型
                    serializeAlgorithm: 6
                }, function (packet) {


                    let flag = false;
                    that.msgRecordList.forEach(item => {
                        // 生成组合唯一标识
                        if (sessionId == item.sessionId) {
                            item.chatMsgList.push({
                                id: that.currentLoginUser.id,
                                username: that.currentLoginUser.username,
                                avatar: that.currentLoginUser.avatar,
                                msgType: 1,
                                msgContent: that.chatContent,
                                timestamp: new Date().getTime()
                            });
                            flag = true;
                            //this.currentChatMsgList = item.chatMsgList;
                        }
                    });
                    if (!flag) {
                        that.msgRecordList.push({
                            sessionId: sessionId,
                            chatMsgList: [
                                {
                                    id: that.currentLoginUser.id,
                                    username: that.currentLoginUser.username,
                                    avatar: that.currentLoginUser.avatar,
                                    msgType: 1,
                                    msgContent: that.chatContent,
                                    timestamp: new Date().getTime()
                                }
                            ],
                        });
                    }
                    // 已经发送的消息packet
                    // 聊天内容置空
                    that.chatContent = '';
                    console.log(packet)
                });

            },
            // 提交设置表单
            submitSettingForm() {
                this.$refs.settingRuleForm.validate((valid) => {
                    if (valid) {
                        this.activeStep++;
                    } else {
                        console.log('error submit!!');
                        return false;
                    }
                });
            },
        }
    })

</script>

<style>
    .container {
        height: 100vh;
    }

    .item {
        margin-top: 10px;
        margin-right: 16px;
    }

    .last-msg {
        display: block;
        text-overflow: ellipsis;
        overflow: hidden;
        word-break: break-all;
        white-space: nowrap;
        color: #909399;
        font-size: 10px;
    }

    .add-friend-container {
        background-color: #f2f2f2;
    }

    .search-container {
        background-color: #F8F8F8;
        padding: 0px 5px;
    }

    .el-dialog__body {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .cq2 {
        display: flex;
        flex-direction: column;
        width: 800px;
        justify-content: center;
        padding: 50px;
        background-color: aliceblue;
    }

    .cq3 {
        display: flex;
        flex-direction: column;
        width: 800px;
        justify-content: center;
        padding: 50px;
        background-color: aliceblue;
    }

    .m2 {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;

    }

    .m5 {
        display: flex;
        justify-content: center;
        margin-bottom: 40px;
        font-size: 24px;
        font-weight: bold;
    }

    .m1 {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
    }

    .main-chat-container {
        border-left: 1px solid #DCDFE6;
        border-right: 1px solid #DCDFE6;
    }

    .el-dropdown-link {
        cursor: pointer;
    }

    .el-header,
    .el-footer {
        background-color: #B3C0D1;
        color: #333;
        text-align: center;
        line-height: 60px;
    }

    .el-steps--horizontal {
        width: 800px;
    }

    .cq1 {
        display: flex;
        align-content: center;
        flex-direction: row;
        justify-content: center;
        margin-bottom: 100px;

    }

    .header-container {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        justify-content: space-between;
        align-items: center;

    }

    .chat-user-msg-my {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        align-items: flex-end;
        justify-content: flex-end;
        margin-right: 10px;
    }

    .chat-header {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        align-content: center;
        justify-content: center;
        align-items: center;
        background-color: #E9EEF3;
    }

    .c1 {
        display: flex;
        flex: 1;
        justify-content: space-between;
        align-content: center;
        align-items: flex-start;
        flex-wrap: nowrap;
        flex-direction: row;
    }

    .c2 {
        display: flex;
        flex-direction: column;
        flex-wrap: nowrap;
        align-content: flex-end;
        justify-content: center;
        align-items: flex-start;
        margin-left: 10px;
    }

    .c3 {
        font-size: 16px;
        color: #303133
    }

    .c4 {
        width: 12vw;
        display: flex;
    }

    .header {
        font-size: 28px;
        font-weight: bold;
    }

    .c5 {
        display: flex;
        flex-direction: row;
        align-content: center;
        justify-content: center;
        align-items: center;
    }

    .chat-container {
        display: flex;
        flex-direction: column;
        background-color: #F8F8F8;
    }

    .c6 {
        display: flex;
        flex: 1;
        justify-content: space-between;
        align-content: center;
        align-items: flex-start;
        flex-wrap: nowrap;
        flex-direction: row;
    }

    .c7 {
        display: flex;
        flex-direction: column;
        flex-wrap: nowrap;
        align-content: flex-end;
        justify-content: center;
        align-items: flex-start;
        margin-left: 10px;
    }

    .c8 {
        font-size: 16px;
        color: #303133
    }

    .c9 {
        width: 12vw;
        display: flex;
    }

    .c10 {
        display: flex;
        flex-direction: row;
        align-content: center;
        justify-content: center;
        align-items: center;
    }

    .c11 {
        display: flex;
        flex: 1;
        justify-content: space-between;
        align-content: center;
        align-items: flex-start;
        flex-wrap: nowrap;
        flex-direction: row;
    }

    .c12 {
        display: flex;
        flex-direction: column;
        flex-wrap: nowrap;
        align-content: flex-end;
        justify-content: center;
        align-items: flex-start;
        margin-left: 10px;
    }

    .c13 {
        display: flex;
        flex-direction: row;
        align-content: center;
        justify-content: center;
        align-items: center;
    }

    .my {
        display: flex;
        flex-direction: row-reverse;
        flex-wrap: nowrap;
        align-items: flex-start;
        margin-bottom: 20px;
    }

    .others {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        align-items: flex-start;
        margin-bottom: 20px;
    }

    .chat-right {
        display: flex;
        flex-direction: column;
        flex-wrap: nowrap;
        max-width: 40vw;
        align-items: flex-end;
    }

    .chat-avatar {
        display: flex;
    }

    .chat-user-msg {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        align-items: flex-end;
    }

    .chat-msg {
        display: flex;
        margin-left: 10px;
        margin-top: 5px;
        font-size: 14px;
        background-color: #FFFFFF;
        text-align: left;
        border-right: 10px;
    }

    .chat-msg-my {
        display: flex;
        margin-right: 10px;
        margin-top: 5px;
        font-size: 14px;
        background-color: #FFFFFF;
        text-align: left;
        border-right: 10px;
    }

    .el-aside {
        background-color: #D3DCE6;
        color: #333;
        text-align: center;
    }

    .el-main {
        color: #333;
        text-align: center;
    }

    body > .el-container {
        margin-bottom: 40px;
    }

    .el-container:nth-child(5) .el-aside,
    .el-container:nth-child(6) .el-aside {
        line-height: 260px;
    }

    .el-container:nth-child(7) .el-aside {
        line-height: 320px;
    }

    .header-login {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        align-items: flex-end;
        justify-content: center;
    }

    .footer-container {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        align-content: center;
        align-items: center;
    }

    .el-tree-node__content {
        height: 50px;
        border-bottom: 1px solid #F2F6FC;
    }

    .custom-tree-node {
        display: flex;
        flex: 1;
        flex-direction: row;
        flex-wrap: nowrap;
        align-content: center;
        justify-content: flex-start;
        align-items: center;
    }

    .divider {
        height: 10px;
        background-color: #e4e7ed;;
    }

    .user-detail-container {
        display: flex;
        flex-direction: column;
    }

    .user-detail {
        margin: 10px;
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        align-content: center;
        align-items: center;
    }

    .user-tools {
        margin: 20px;
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        align-content: center;
        justify-content: space-around;
        align-items: center;
    }

    .left-avatar {
        display: flex;
    }

    .right-user-info {
        display: flex;
        margin-left: 10px;
    }

    .item-dot {
        margin-right: 60px;
    }

    .el-drawer__body {
        background-color: #F8F8F8;
    }

    .el-dropdown {
        height: 40px;
    }
    .el-radio {
        display: flex;
        color: #606266;
        font-weight: 500;
        line-height: 1;
        cursor: pointer;
        white-space: nowrap;
        outline: 0;
        margin-right: 30px;
        flex-direction: row;
        align-items: center;
    }
    .el-checkbox {
        display: flex;
        color: #606266;
        font-weight: 500;
        font-size: 14px;
        cursor: pointer;
        user-select: none;
        margin-right: 30px;
        flex-direction: row;
        flex-wrap: nowrap;
        align-content: center;
        align-items: center;
    }
    .el-checkbox__label {
        flex: 1;
        display: inline-block;
        padding-left: 10px;
        line-height: 19px;
        font-size: 14px;
    }
    .el-radio-group {
        width: 100%;
        font-size: 0;
    }
    .el-radio__label {
        flex: 1;
        display: inline-block;
        padding-left: 10px;
        line-height: 19px;
        font-size: 14px;
    }
    .notice {
        background-color: #FFFFFF;
        margin-bottom: 3px;
        padding: 5px 10px;
        display: flex;
        flex: 1;
        flex-direction: row;
        flex-wrap: nowrap;
        align-content: center;
        justify-content: flex-start;
        align-items: center;
    }
</style>
</body>

</html>
