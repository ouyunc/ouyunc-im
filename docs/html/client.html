<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>测试websocket</title>
</head>

<script src="./snowflake-id.js"></script>
<script src="../protobuf/ouyunc-message.js"></script>


<script>

	let identity;
	let currentChatIdentity;
	let websocket = null;
	let heartbeart_timeout = null;
	let serverTimeoutObj = null;

	function init(wsUrl) {
		let socket = new WebSocket(wsUrl);
		socket.onopen = function (e) {
			console.log('连接成功')
		};
		socket.onmessage = function (e) {
			console.log('连接收到消息',e.data)
			let element = document.getElementById("receiveTimeline");

			// 收到消息重置心跳
			startHeartbeat();
			parseMessage(e.data).then(function (packet) {
				console.log(packet.message + "====" + packet.messageType + "====" + packet.messageId)
				let elementcontact = document.getElementById("contact");

				console.log(packet.message.getFrom())
				if (packet.messageType === 1 && packet.message.getContentType() === 4) {
					//element.insertAdjacentHTML('beforeend',"收到服务端:"+ packet.message.getFrom() + "的响应心跳PONG")
				} else if (packet.messageType === 8 && packet.message.getContentType() === 11) {
					element.insertAdjacentHTML('beforeend','收到客户端:'+packet.message.getFrom() + '的添加好友申请' + '<button onclick="agreeFriend(\''+packet.message.getFrom() +'\')">同意</button><button onclick="refuseFriend(\''+packet.message.getFrom()+'\')">拒绝</button>');
				}else if (packet.messageType === 8 && packet.message.getContentType() === 13){
					// 将发送者添加到联系人
					elementcontact.insertAdjacentHTML('beforeend','<div onclick="selectChat(\''+packet.message.getFrom()+'\')" style="border-bottom:1px solid black;margin-top:10px"><a href="#">'+packet.message.getFrom() +'(个人)</a><button style="margin-left:10px">屏蔽</button><button style="margin-left:10px">拉黑</button><button onclick="readReceipt()" style="margin-left:10px">按需拉取离线消息</button></div>');
				}else if (packet.messageType === 3 && packet.message.getContentType() === 7) {
					console.log(packet.message.getContent())
					element.insertAdjacentHTML('beforeend',"收到服务端:"+ packet.message.getFrom() + "的响应心跳relay ack")
				}else if (packet.messageType === 5 && packet.message.getContentType() === 50) {
					element.insertAdjacentHTML('beforeend',"收到客户端:"+ packet.message.getFrom() + "的私聊消息："+ packet.message.getContent())
				}else if (packet.messageType === 9 && packet.message.getContentType() === 21) {
					element.insertAdjacentHTML('beforeend','收到客户端:'+packet.message.getFrom() + '的加群申请' + '<button onclick="agreeJoinGroup(\''+packet.message.getFrom() +'\',\''+JSON.parse(packet.message.getContent()).groupId+'\')">同意</button><button onclick="refuseJoinGroup(\''+packet.message.getFrom()+'\',\''+JSON.parse(packet.message.getContent()).groupId+'\')">拒绝</button>');
				}else if (packet.messageType === 9 && packet.message.getContentType() === 23) {
					elementcontact.insertAdjacentHTML('beforeend','<div onclick="selectChat(\''+JSON.parse(packet.message.getContent()).groupId+'\')" style="border-bottom:1px solid black;margin-top:10px"><a href="#">'+JSON.parse(packet.message.getContent()).groupId+'（群组）</a><button style="margin-left:10px" onclick="shieldGroup(\''+JSON.parse(packet.message.getContent()).groupId+'\')">屏蔽</button><button onclick="exitGroup(\''+JSON.parse(packet.message.getContent()).groupId+'\')" style="margin-left:10px">退群</button><button onclick="disbandGroup(\''+JSON.parse(packet.message.getContent()).groupId+'\')" style="margin-left:10px">解散群</button><button style="margin-left:10px">按需拉取离线消息</button></div>');

				}else if (packet.messageType === 6 && packet.message.getContentType() === 50) {
					element.insertAdjacentHTML('beforeend','收到群的聊天信息：' + packet.message.getContent());

				}

			});

		};
		socket.onclose = function (e) {
			console.log('连接关闭')

		};
		socket.onerror = function (e) {
			console.log('连接异常')
		}
		websocket = socket;
	}
	// 连接
	function connect() {
		//"ws://192.168.0.106:8001/"
		let element = document.getElementById("wsUrl");
		init(element.value)
	}
	// 断开
	function disconnect() {
		websocket.close();
	}


	// 登录
	function login() {
		let element = document.getElementById("loginUserId");
		identity = element.value;
		const timestamp = new Date().getTime();
		let loginMessage = new proto.com.ouyunc.im.Message();
		loginMessage.setFrom(identity);
		loginMessage.setCreateTime(timestamp);
		loginMessage.setContentType(5)
		loginMessage.setContent(JSON.stringify({
			"identity": identity,
			"appKey": 123456,
			"createTime": timestamp,
			"signatureAlgorithm": 0,
			"signature": ''
		}))
		let messageDataBinary = loginMessage.serializeBinary();
		let packetDataView = wrapMessage(messageDataBinary, 2);
		// 发送登录消息
		websocket.send(packetDataView.buffer);
	}


	// 开始发起心跳
	function startHeartbeat() {
		// 超时3次才关闭
		let _retry = 3;
		// 将两个超时值清空
		heartbeart_timeout && clearInterval(heartbeart_timeout);
		serverTimeoutObj && clearTimeout(serverTimeoutObj);
		heartbeart_timeout = setInterval(function () {
			//这里发送一个心跳，后端收到后，返回一个心跳消息，
			//onmessage拿到返回的心跳就说明连接正常
			let heartBeatMessage = new proto.com.ouyunc.im.Message();
			heartBeatMessage.setFrom(identity);
			heartBeatMessage.setContentType(3);
			heartBeatMessage.setCreateTime(new Date().getTime());
			let messageDataBinary = heartBeatMessage.serializeBinary();
			let packetDataView = wrapMessage(messageDataBinary, 1);
			// 发送心跳信息
			websocket.send(packetDataView.buffer);

			// 次数减一
			_retry--;
			// 如果超过一定时间还没重置，说明后端主动断开了
			serverTimeoutObj = setTimeout(function () {
				//如果onclose会执行reconnect，我们执行 websocket.close()就行了.如果直接执行 reconnect 会触发onclose导致重连两次
				//计算答复的超时次数
				if (_retry === 0) {
					console.log("close" + _retry);
					// 等待发送三次心跳（也就是30秒过后），
					// 服务端都没有响应就会关闭前端websocket，当关闭websocket时，就会触发相应的操作比如重连
					websocket.close();
				}
			}, 5000)
		}, 10000)
	};

	// 停止发送心跳
	function stopHeartbeat() {
		heartbeart_timeout && clearInterval(heartbeart_timeout);
		serverTimeoutObj && clearTimeout(serverTimeoutObj);
	}

	// 添加好友
	function addFriend() {
		let element = document.getElementById("addFriend");
		let message = new proto.com.ouyunc.im.Message();
		message.setFrom(identity);
		message.setTo(element.value)
		message.setContentType(11);
		message.setCreateTime(new Date().getTime());
		let messageDataBinary = message.serializeBinary();
		let packetDataView = wrapMessage(messageDataBinary, 8);
		// 发送心跳信息
		websocket.send(packetDataView.buffer);
	}

	// 同意好友申请
	function agreeFriend(to) {

		let message = new proto.com.ouyunc.im.Message();
		message.setFrom(identity);
		message.setTo(to)
		message.setContentType(13);
		message.setCreateTime(new Date().getTime());
		let messageDataBinary = message.serializeBinary();
		let packetDataView = wrapMessage(messageDataBinary, 8);
		// 发送心跳信息
		websocket.send(packetDataView.buffer);

		let element = document.getElementById("contact");
		element.insertAdjacentHTML('beforeend','<div onclick="selectChat(\''+to+'\')" style="border-bottom:1px solid black;margin-top:10px"><a href="#">'+to+'(个人)</a><button style="margin-left:10px">屏蔽</button><button style="margin-left:10px">拉黑</button><button style="margin-left:10px">按需拉取离线消息</button></div>');

	}

	// 加入群组
	function joinGroup() {
		let element = document.getElementById("joinGroup");
		let message = new proto.com.ouyunc.im.Message();
		message.setFrom(identity);
		message.setTo(element.value)
		message.setContentType(21);
		message.setContent(JSON.stringify({
			"groupId": element.value,
			"identity": identity
		}))
		message.setCreateTime(new Date().getTime());
		let messageDataBinary = message.serializeBinary();
		let packetDataView = wrapMessage(messageDataBinary, 9);
		// 发送心跳信息
		websocket.send(packetDataView.buffer);
	}
	// 同意加群
	 function agreeJoinGroup(to, groupId) {
		 let message = new proto.com.ouyunc.im.Message();
		 message.setFrom(identity);
		 message.setTo(to)
		 message.setContentType(23);
		 message.setContent(JSON.stringify({
			 "groupId": groupId,
			 "identity": to
		 }))
		 message.setCreateTime(new Date().getTime());
		 let messageDataBinary = message.serializeBinary();
		 let packetDataView = wrapMessage(messageDataBinary, 9);
		 // 发送心跳信息
		 websocket.send(packetDataView.buffer);
		 let elementcontact = document.getElementById("contact");

		 elementcontact.insertAdjacentHTML('beforeend','<div onclick="selectChat(\''+groupId+'\')" style="border-bottom:1px solid black;margin-top:10px"><a href="#">'+groupId+'（群组）</a><button style="margin-left:10px">屏蔽</button><button style="margin-left:10px">退群</button><button style="margin-left:10px" onclick="disbandGroup(\'1609083738557259778\')">解散群</button><button style="margin-left:10px">按需拉取离线消息</button></div>');

	 }

	 // 拒绝加群
	 function refuseJoinGroup(to,groupId) {
		 let message = new proto.com.ouyunc.im.Message();
		 message.setFrom(identity);
		 message.setTo(to)
		 message.setContentType(22);
		 message.setContent(JSON.stringify({
			 "groupId": groupId,
			 "identity": to
		 }))
		 message.setCreateTime(new Date().getTime());
		 let messageDataBinary = message.serializeBinary();
		 let packetDataView = wrapMessage(messageDataBinary, 9);
		 // 发送心跳信息
		 websocket.send(packetDataView.buffer);
	 }

	 // 退出群
	 function exitGroup(groupId) {
		 let message = new proto.com.ouyunc.im.Message();
		 message.setFrom(identity);
		 message.setTo(groupId)
		 message.setContentType(26);
		 message.setContent(JSON.stringify({
			 "groupId": groupId,
			 "identity": identity
		 }))
		 message.setCreateTime(new Date().getTime());
		 let messageDataBinary = message.serializeBinary();
		 let packetDataView = wrapMessage(messageDataBinary, 9);
		 // 发送心跳信息
		 websocket.send(packetDataView.buffer);

	 }
	 // 解散群
	 function disbandGroup(groupId) {
		 let message = new proto.com.ouyunc.im.Message();
		 message.setFrom(identity);
		 message.setTo('1609083738557259778')
		 message.setContentType(24);
		 message.setContent(JSON.stringify({
			 "groupId": '1609083738557259778',
			 "identity": identity
		 }))
		 message.setCreateTime(new Date().getTime());
		 let messageDataBinary = message.serializeBinary();
		 let packetDataView = wrapMessage(messageDataBinary, 9);
		 // 发送心跳信息
		 websocket.send(packetDataView.buffer);
	 }
	 // 屏蔽群
	 function shieldGroup(groupId) {
		 let message = new proto.com.ouyunc.im.Message();
		 message.setFrom(identity);
		 message.setTo(groupId)
		 message.setContentType(27);
		 message.setContent(JSON.stringify({
			 "groupId": groupId,
			 "identity": identity
		 }))
		 message.setCreateTime(new Date().getTime());
		 let messageDataBinary = message.serializeBinary();
		 let packetDataView = wrapMessage(messageDataBinary, 9);
		 // 发送心跳信息
		 websocket.send(packetDataView.buffer);
	 }
	// 私聊
	function chat() {
		let element = document.getElementById("chatContent");

		let message = new proto.com.ouyunc.im.Message();
		message.setFrom(identity);
		message.setTo(currentChatIdentity)
		message.setContentType(50);
		message.setContent(element.value);
		message.setCreateTime(new Date().getTime());
		let messageDataBinary = message.serializeBinary();
		let packetDataView = wrapMessage(messageDataBinary, 5);
		// 发送心跳信息
		websocket.send(packetDataView.buffer);
	}

	// 选中聊天人
	function selectChat(to) {
		currentChatIdentity = to;
	}
	// 屏蔽好友
	function shield(to) {

	}

	// 拒绝好友申请
	function refuseFriend(to) {
		let message = new proto.com.ouyunc.im.Message();
		message.setFrom(identity);
		message.setTo(to)
		message.setContentType(12);
		message.setCreateTime(new Date().getTime());
		let messageDataBinary = message.serializeBinary();
		let packetDataView = wrapMessage(messageDataBinary, 8);
		// 发送心跳信息
		websocket.send(packetDataView.buffer);
	}

	// 回应收到的ack
	function replyAck(to,packetId,deviceType) {
		let message = new proto.com.ouyunc.im.Message();
		message.setFrom(identity);
		message.setTo(to)
		message.setContentType(6);
		message.setContent(JSON.stringify({
			"packetId": packetId.toString(),
			"deviceType":deviceType
		}))
		message.setCreateTime(new Date().getTime());
		let messageDataBinary = message.serializeBinary();
		let packetDataView = wrapMessage(messageDataBinary, 3);
		// 发送心跳信息
		websocket.send(packetDataView.buffer);
	}
	// 读回执
	function readReceipt() {
		var contentList = [{
			"identity":'1608716568920965121',
			"packetId":'1609445308520075264'
		},{
			"identity":'1608716568920965121',
			"packetId":'1609445908905332736'
		}];
		let message = new proto.com.ouyunc.im.Message();
		message.setFrom(identity);
		message.setTo('1608716568920965121')
		message.setContentType(9);
		message.setContent(JSON.stringify([]))
		message.setCreateTime(new Date().getTime());
		let messageDataBinary = message.serializeBinary();
		let packetDataView = wrapMessage(messageDataBinary, 4);
		// 发送心跳信息
		websocket.send(packetDataView.buffer);
	}

	// 包装消息
	function wrapMessage(dataBinary, messageType) {
		let snowflake = new Snowflake(1n, 1n, 0n);
		// 构建packet协议数据包&发送出去
		//定制协议前部固定长度
		let header = 24;
		// 消息字节长度
		let byteLength = dataBinary.byteLength;
		//总字节长度
		let len = header + byteLength;
		// 初始化Byte的二进制数据缓冲区
		let arrBuffer = new ArrayBuffer(len);
		// 加载分配好的缓冲区, 注意默认大端序读写
		let dataView = new DataView(arrBuffer);
		// 设置数据，魔数magic                                         // offset
		dataView.setInt8(0, 102);//  0
		//包协议， 1个字节
		dataView.setInt8(1, 1); // 0+1
		//协议版本号，1个字节
		dataView.setInt8(2, 1); // 0+1+1
		//协议包id 8个字节, 雪花id
		dataView.setBigInt64(3, snowflake.nextId()); // 0+1+1+1
		//设备类型 1个字节，m-android/m-ios/pc-windows/pc-mac/pad...
		dataView.setInt8(11, 13);// 0+1+1+1+8
		//网络类型 1个字节， 其他， wifi,5g,4g,3g,2g
		dataView.setInt8(12, 0);// 0+1+1+1+8+1
		//发送方ip 4个字节
		dataView.setInt32(13, ip2Int('127.0.0.1'));// 0+1+1+1+8+1+1
		//消息加密，1个字节，加密方式，不加密/AES/...对称加密，防止消息泄密;这里暂时不加密
		dataView.setInt8(17, 0);// 0+1+1+1+8+1+1+4
		//序列化算法 1 个字节，protoBUf，采用protoStuf 的加密算法
		dataView.setInt8(18, 6);// 0+1+1+1+8+1+1+4+1
		//消息类型 1 个字节，这里是登录消息，如 RPC 框架中有请求、响应、心跳类型。IM 通讯场景中有登陆、创建群聊、发送消息、接收消息、退出群聊等类型。
		dataView.setInt8(19, messageType);// 0+1+1+1+8+1+1+4+1+1
		//判断是否需要加密，何种算法加密,这里先不加密
		//加密后的消息长度.4个字节
		dataView.setInt32(20, byteLength); //0+1+1+1+8+1+1+4+1+1+1
		//加密后的消息内容，n个字节, 不同的消息类型有可能是不同的数据内容
		for (let i = 0; i < byteLength; i++) {
			dataView.setInt8(header + i, dataBinary[i]);
		}
		return dataView;
	}

	// 解析包数据
	function parseMessage(packetDataBinary) {
		// 注意：这里只要new Promise 就会执行，不需要手动调用
		return new Promise(function (resolve, reject) {
			//做一些异步操作
			// 定义文件读取类
			let reader = new FileReader();
			// 将blob 二进制数据转file
			reader.readAsArrayBuffer(packetDataBinary);
			// 由于reader 是异步所以使用promise 包装
			reader.onload = function () {
				//定制协议前部固定长度
				let header = 24;
				let packetBuffer = new DataView(reader.result);
				//跳过魔数 1个字节
				let magic = packetBuffer.getInt8(0);// 0
				//包协议， 1个字节
				let protocol = packetBuffer.getInt8(1);// 0+1
				//协议版本号，1个字节
				let protocolVersion = packetBuffer.getInt8(2);// 0+1+1
				//协议包id 8个字节
				let packetId = packetBuffer.getBigInt64(3);// 0+1+1+1
				//设备类型 1个字节，m-android/m-ios/pc-windows/pc-mac/pad...
				let deviceType = packetBuffer.getInt8(11);// 0+1+1+1+8
				//网络类型 1个字节 wifi,5g,4g,3g,2g...
				let networkType = packetBuffer.getInt8(12);// 0+1+1+1+8+1
				// 发送端ip 4个字节
				let ip = packetBuffer.getInt32(13);// 0+1+1+1+8+1+1
				//消息加密，1个字节，加密方式，不加密/AES/...对称加密，防止消息泄密
				let encryptType = packetBuffer.getInt8(17);// 0+1+1+1+8+1+1+4
				//序列化算法 1 个字节，json/jdk/hessian/kryo/protoStuff(protoBUf)
				let serializeAlgorithm = packetBuffer.getInt8(18);// 0+1+1+1+8+1+1+4+1
				//消息类型,1个字节
				let messageType = packetBuffer.getInt8(19);// 0+1+1+1+8+1+1+4+1+1
				//加密后的消息长度.4个字节
				let messageLength = packetBuffer.getInt32(20);// 0+1+1+1+8+1+1+4+1+1+1

				let message = new ArrayBuffer(messageLength);
				let messageDV = new DataView(message);
				for (let i = 0; i < messageLength; i++) {
					messageDV.setInt8(i, packetBuffer.getInt8(header + i));
				}
				// 定义客户端需要处理的消息
				let messageObj = proto.com.ouyunc.im.Message.deserializeBinary(message);
				// 判断是什么消息类型就转成什么消息返回给前端
				switch (messageType) {
					case 5:
						replyAck(messageObj.getFrom(), packetId, deviceType);
						break;
				}
				// 将message result 返回
				resolve({
					message: messageObj,
					messageType: messageType,
					messageId: packetId,
				})
			}

		});
	}


	// 将字符串ip 转int
	function ip2Int(strIp) {
		let ipArr = strIp.split(".");
		let buffer = new ArrayBuffer(4);
		let dataView = new DataView(buffer);
		for (let i = 0; i < ipArr.length; i++) {
			dataView.setInt8(i, parseInt(ipArr[i]));
		}
		return (dataView.getInt8(3) & 0xFF) | ((dataView.getInt8(2) << 8) & 0xFF00) | ((dataView.getInt8(1) << 16) & 0xFF0000) | ((dataView.getInt8(0) << 24) & 0xFF000000);
	}





</script>
<body>
	<div style="display:flex;flex-direction: column">
		<div style="height: 100%; width: 100%;border:1px solid black;display:flex;flex-direction: column">
			<div style="display:flex;flex-direction: row">
				
				<div>
				  <div style="text-align:center">
					在线好友列表
				  </div>
				  <div id="contact" style="display:flex;flex-direction: column;height: 600px; width: 550px;border:1px solid black;margin-left:10px">

					<div style="border-bottom:1px solid black;margin-top:10px"><a href="#">张三（个人）</a><button style="margin-left:10px">同意</button><button style="margin-left:10px">拒绝</button><button style="margin-left:10px">屏蔽</button><button style="margin-left:10px">拉黑</button><button onclick="readReceipt()" style="margin-left:10px">按需拉取离线消息</button></div>
				  	<div style="border-bottom:1px solid black;margin-top:10px">
						<a href="#">偶云客（群组）</a><button style="margin-left:10px">同意</button><button style="margin-left:10px">拒绝</button><button style="margin-left:10px">屏蔽</button><button style="margin-left:10px">退群</button><button style="margin-left:10px">解散群</button><button style="margin-left:10px">按需拉取离线消息</button>
						<div style="margin-left:20px;font-size:12px"><a href="#">李四（群成员）</a><button style="margin-left:10px">踢出群</button><button style="margin-left:10px">拉黑</button></div>
					</div>

				  </div>
				</div>
				
				<div>
					<div style="text-align:center">
						发件箱
					</div>
					<div style="height: 600px; width: 200px;border:1px solid black;margin-left:50px">
						来自xxx的群聊消息：你们好
					</div>
				</div>
				
				<div>
					<div style="text-align:center">
						收件箱
					</div>
					<div id="receiveTimeline" style="height: 600px; width: 200px;border:1px solid black;margin-left:50px">

					</div>
				</div>
				
				<div>
					<div style="text-align:center">
						功能菜单区
					</div>
					<div style="height: 600px; width: 400px;border:1px solid red;margin-left:20px;display:flex;flex-direction:column;">
					<div style="margin-top:10px">
						<form action="http://localhost:8090/im-user/register" onsubmit="return register();" method="post">
						用户名: <input type="text" name="username"><br>
						昵  称 :   <input type="text" name="nickName"><br>
						手机号: <input type="text" name="phoneNum"><br>
								<input type="submit" value="注册用户">
						</form>
					</div>
					
					<div style="margin-top:20px">
						<span>输入手机号查询用户信息：</span> <input type="text" name="phoneNum" style="width:100px"> <button>查询</button>
					</div>

						
						
						
					<div style="margin-top:200px"><span>ws地址:</span> <input id="wsUrl" value="ws://192.168.0.105:8001/" style="width:200px"/> <button onclick="connect()">连接</button><button onclick="disconnect()" style="margin-left:10px">断开</button></div>
					<div style="margin-top:10px"><span>输入登录唯一标识（用户id）:</span> <input id="loginUserId" style="width:110px"/><button onclick="login()" style="margin-left:10px">登录</button></div>
					
					<div style="margin-top:10px"><button onclick="startHeartbeat()" style="margin-left:10px">开始发送心跳</button><button onclick="stopHeartbeat()" style="margin-left:10px">停止心跳</button><button style="margin-left:10px">全量拉取离线消息</button></div>
					<div style="margin-top:20px"><span>好友ID:</span> <input id="addFriend" style="width:200px"/><button style="margin-left:10px" onclick="addFriend()">加好友</button></div>
					<div style="margin-top:10px"><span>群ID   :</span> <input id="joinGroup" style="width:200px"/><button style="margin-left:10px" onclick="joinGroup()">加入群</button></div>
					</div>
				</div>
			</div>
			<div style="height:80px;display:flex;align-items: center;margin-left: 10px;">
				<textarea id="chatContent" rows="1" cols="60" style="height:30px"></textarea>
				<button onclick="chat()" style="margin-left:20px;height:35px;width:200px">点击发送</button>
			</div>
		</div>
	</div>




</body>
</html>